<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Playlist Tournament</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    .hidden {
      display: none;
    }
    .matchup {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
    }
    .song {
      display: inline-block;
      vertical-align: top;
      width: 45%;
      text-align: center;
      margin: 10px;
      font-size: 18px;
    }
    iframe {
      border: none;
      margin-top: 5px;
    }
    button {
      margin: 10px 5px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    #tokenInput {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Spotify Playlist Tournament</h1>
  <p>Enter your Spotify playlist URL:</p>
  <input type="text" id="playlistUrl" placeholder="https://open.spotify.com/playlist/..." size="50"><br>

  <p>Enter your Spotify Access Token:</p>
  <input type="text" id="accessToken" placeholder="Paste your access token here" size="50" id="tokenInput"><br>

  <details style="margin-top: 10px;" id="instructions">
    <summary><strong>How to get your Spotify Access Token</strong></summary>
    <ol>
      <li>Go to <a href="https://developer.spotify.com/dashboard/applications" target="_blank">Spotify Developer Dashboard</a>.</li>
      <li>Log in and click "Create an App".</li>
      <li>Give it a name and description (anything is fine), then click "Create".</li>
      <li>Open your new app, then click "Show Client Secret".</li>
      <li>Copy your <strong>Client ID</strong> and <strong>Client Secret</strong>.</li>
      <li>Open a terminal or command prompt and run the following command (replacing the placeholders):</li>
      <pre style="background:#f4f4f4;padding:10px;border-radius:5px;overflow-x:auto;"><code>
curl -X POST -H "Authorization: Basic <base64-encoded-clientid:clientsecret>" \
-d grant_type=client_credentials \
https://accounts.spotify.com/api/token
      </code></pre>
      <li>To create the <code>Authorization</code> header, base64 encode your <code>client_id:client_secret</code>:
        <ul>
          <li><strong>Linux / macOS:</strong> Use <code>echo -n 'client_id:client_secret' | base64</code></li>
          <li><strong>Windows (PowerShell):</strong>
            <pre style="background:#f4f4f4;padding:10px;border-radius:5px;overflow-x:auto;"><code>
[Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("client_id:client_secret"))
            </code></pre>
          </li>
        </ul>
      </li>
      <li>The response will contain your <code>access_token</code>. Copy it and paste it above.</li>
    </ol>
  </details>

  <button id="fetchPlaylist">Fetch Playlist & Start Tournament</button>
 <button onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSf3nDaN8juefh8H9wV8YZOwraH2XPXpIVYP-U4j-7XKycMxyA/viewform?usp=dialog/viewform', '_blank')">Suggestions</button>
<iframe id="suggestionsFrame" class="hidden" src="" width="640" height="800"></iframe>

  <div id="error" style="color: red; margin-top:10px;"></div>
  <div id="matchups" class="hidden"></div>
  <div id="ranking" class="hidden"></div>

  <script>
    let tracks = [];
    let matchups = [];
    let currentMatchupIndex = 0;
    let results = {};

    function extractPlaylistID(url) {
      const regex = /playlist\/([a-zA-Z0-9]+)(?:\?si=.*)?/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    function generateMatchups(tracks) {
      const pairs = [];
      for (let i = 0; i < tracks.length; i++) {
        for (let j = i + 1; j < tracks.length; j++) {
          pairs.push({ song1: tracks[i], song2: tracks[j] });
        }
      }
      return pairs;
    }

    function displayCurrentMatchup() {
      const matchupDiv = document.getElementById("matchups");
      matchupDiv.innerHTML = "";
      if (currentMatchupIndex >= matchups.length) {
        displayRanking();
        return;
      }
      const matchup = matchups[currentMatchupIndex];
      const heading = document.createElement("h2");
      heading.textContent = "Matchup " + (currentMatchupIndex + 1) + " of " + matchups.length;
      matchupDiv.appendChild(heading);
      const container = document.createElement("div");
      container.className = "matchup";

      function createSongBlock(song) {
        const songDiv = document.createElement("div");
        songDiv.className = "song";
        const title = document.createElement("p");
        title.textContent = song.name + " by " + song.artists.join(", ");
        songDiv.appendChild(title);
        const iframe = document.createElement("iframe");
        iframe.src = "https://open.spotify.com/embed/track/" + song.id;
        iframe.width = "300";
        iframe.height = "80";
        songDiv.appendChild(iframe);
        return songDiv;
      }

      container.appendChild(createSongBlock(matchup.song1));
      container.appendChild(createSongBlock(matchup.song2));
      matchupDiv.appendChild(container);

      const button1 = document.createElement("button");
      button1.textContent = "Select Winner: " + matchup.song1.name;
      button1.onclick = () => recordWin(matchup.song1.id);

      const button2 = document.createElement("button");
      button2.textContent = "Select Winner: " + matchup.song2.name;
      button2.onclick = () => recordWin(matchup.song2.id);

      matchupDiv.appendChild(button1);
      matchupDiv.appendChild(button2);
    }

    function recordWin(trackId) {
      results[trackId] = (results[trackId] || 0) + 1;
      currentMatchupIndex++;
      displayCurrentMatchup();
    }

    function displayRanking() {
      document.getElementById("matchups").classList.add("hidden");
      const rankingDiv = document.getElementById("ranking");
      rankingDiv.innerHTML = "<h2>Final Ranking</h2>";
      let rankingArray = tracks.map(track => ({
        id: track.id,
        name: track.name,
        artists: track.artists.join(", "),
        wins: results[track.id] || 0
      }));
      rankingArray.sort((a, b) => b.wins - a.wins);
      const ol = document.createElement("ol");
      rankingArray.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item.name + " by " + item.artists + " â€” Wins: " + item.wins;
        ol.appendChild(li);
      });
      rankingDiv.appendChild(ol);
      rankingDiv.classList.remove("hidden");
    }

    async function fetchPlaylistTracks(playlistId, accessToken) {
      let allTracks = [];
      let offset = 0;
      let limit = 100;
      let total = 1;

      while (offset < total) {
        const endpoint = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?offset=${offset}&limit=${limit}`;
        const response = await fetch(endpoint, {
          headers: { "Authorization": "Bearer " + accessToken }
        });
        if (!response.ok) throw new Error("Spotify API error " + response.status);
        const data = await response.json();
        total = data.total;
        const newTracks = data.items.map(item => ({
          id: item.track?.id,
          name: item.track?.name ?? "Unknown",
          artists: item.track?.artists?.map(a => a.name) ?? ["Unknown"]
        })).filter(track => track.id);
        allTracks.push(...newTracks);
        offset += limit;
      }
      return allTracks;
    }

    document.getElementById("fetchPlaylist").addEventListener("click", async () => {
      document.getElementById("error").textContent = "";
      const playlistUrl = document.getElementById("playlistUrl").value;
      const accessToken = document.getElementById("accessToken").value.trim();
      if (!accessToken) {
        document.getElementById("error").textContent = "Please enter your Spotify Access Token.";
        return;
      }
      const playlistId = extractPlaylistID(playlistUrl);
      if (!playlistId) {
        document.getElementById("error").textContent = "Invalid Spotify playlist URL.";
        return;
      }
      tracks = await fetchPlaylistTracks(playlistId, accessToken);
      if (tracks.length < 2) {
        document.getElementById("error").textContent = "Playlist must contain at least two tracks.";
        return;
      }
      results = {};
      tracks.forEach(track => { results[track.id] = 0; });
      matchups = generateMatchups(tracks);
      currentMatchupIndex = 0;
      document.getElementById("matchups").classList.remove("hidden");
      document.getElementById("ranking").classList.add("hidden");
      document.getElementById("accessToken").classList.add("hidden");
      document.getElementById("playlistUrl").classList.add("hidden");
      document.getElementById("fetchPlaylist").classList.add("hidden");
      document.getElementById("instructions").classList.add("hidden");
      displayCurrentMatchup();
    });
  </script>
</body>
</html>
